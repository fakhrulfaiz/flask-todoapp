{% extends "base.html" %}

{% block title %}Tasks{% endblock %}

{% block extra_styles %}
/* ── Layout ── */
.app-wrapper {
  max-width: 640px;
  margin: 60px auto;
  padding: 0 20px;
}

/* ── Header ── */
.app-header {
  margin-bottom: 28px;
}

.app-header h1 {
  font-size: 20px;
  font-weight: 600;
  color: #111;
  letter-spacing: -0.2px;
}

.app-header p {
  margin-top: 4px;
  font-size: 13px;
  color: #888;
}

/* ── Add form ── */
.add-form {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
}

.add-form input[type="text"] {
  flex: 1;
  height: 38px;
  padding: 0 12px;
  border: 1px solid #d1d1d1;
  border-radius: 6px;
  background: #fff;
  font-family: inherit;
  font-size: 14px;
  color: #111;
  outline: none;
  transition: border-color 0.15s;
}

.add-form input[type="text"]::placeholder { color: #bbb; }
.add-form input[type="text"]:focus { border-color: #555; }

.btn-add {
  height: 38px;
  padding: 0 16px;
  background: #111;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s;
  white-space: nowrap;
}
.btn-add:hover { background: #333; }

/* ── Stats ── */
.stats {
  display: flex;
  justify-content: space-between;
  font-size: 12px;
  color: #999;
  margin-bottom: 12px;
  padding: 0 2px;
}

/* ── Todo list ── */
.todo-list {
  display: flex;
  flex-direction: column;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  overflow: hidden;
  background: #fff;
}

.todo-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 13px 16px;
  border-bottom: 1px solid #f0f0f0;
  transition: background 0.1s;
}
.todo-item:last-child { border-bottom: none; }
.todo-item:hover { background: #fafafa; }

/* Checkbox-style toggle */
.toggle-btn {
  width: 18px;
  height: 18px;
  border-radius: 4px;
  border: 1.5px solid #ccc;
  background: #fff;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  color: transparent;
  flex-shrink: 0;
  transition: border-color 0.15s, background 0.15s;
  padding: 0;
}
.toggle-btn:hover { border-color: #555; }

.todo-item.is-done .toggle-btn {
  background: #111;
  border-color: #111;
  color: #fff;
}

/* Title */
.todo-title {
  flex: 1;
  font-size: 14px;
  color: #111;
  line-height: 1.4;
}
.todo-item.is-done .todo-title {
  color: #aaa;
  text-decoration: line-through;
}

/* Delete button */
.delete-btn {
  width: 26px;
  height: 26px;
  border: none;
  border-radius: 4px;
  background: transparent;
  color: #ccc;
  font-size: 16px;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: color 0.15s, background 0.15s;
  padding: 0;
  opacity: 0;
}
.todo-item:hover .delete-btn {
  opacity: 1;
}
.delete-btn:hover {
  color: #e55;
  background: #fff0f0;
}

/* ── Empty state ── */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: #bbb;
  border: 1px solid #e5e5e5;
  border-radius: 8px;
  background: #fff;
}
.empty-state p { font-size: 14px; margin-top: 8px; }
{% endblock %}

{% block content %}
<div class="app-wrapper">

  <div class="app-header">
    <h1>My Tasks</h1>
    {% if todos %}
    {% set done_count = todos | selectattr("done") | list | length %}
    <p>{{ done_count }} of {{ todos | length }} completed</p>
    {% else %}
    <p>No tasks yet</p>
    {% endif %}
  </div>

  <!-- Add task -->
  <form class="add-form" id="add-form" method="post" action="/ui/todos">
    <input
      id="add-input"
      type="text"
      name="title"
      placeholder="Add a task…"
      autocomplete="off"
      required
    />
    <button type="submit" class="btn-add">Add task</button>
  </form>

  <!-- Task list -->
  {% if todos %}
  <div class="todo-list" id="todo-list">
    {% for todo in todos %}
    <div class="todo-item {% if todo.done %}is-done{% endif %}" data-id="{{ todo.id }}">

      <!-- Toggle checkbox -->
      <button class="toggle-btn" title="Toggle done">
        {% if todo.done %}✓{% endif %}
      </button>

      <span class="todo-title">{{ todo.title }}</span>

      <!-- Delete -->
      <button class="delete-btn" title="Delete">×</button>

    </div>
    {% endfor %}
  </div>

  {% else %}
  <div class="todo-list" id="todo-list"></div>
  <div class="empty-state" id="empty-state">
    <span style="font-size:28px">☑</span>
    <p>All clear — add a task above to get started.</p>
  </div>
  {% endif %}

</div>

<script>
  const list = document.getElementById('todo-list');
  const emptyState = document.getElementById('empty-state');
  const subtitle = document.querySelector('.app-header p');

  function updateSubtitle() {
    const items = list ? list.querySelectorAll('.todo-item') : [];
    const done  = list ? list.querySelectorAll('.todo-item.is-done').length : 0;
    if (subtitle) {
      subtitle.textContent = items.length
        ? `${done} of ${items.length} completed`
        : 'No tasks yet';
    }
    if (emptyState) {
      emptyState.style.display = (!list || items.length === 0) ? 'block' : 'none';
    }
    if (list) {
      list.style.display = list.querySelectorAll('.todo-item').length === 0 ? 'none' : '';
    }
  }

  function makeItem(todo) {
    const div = document.createElement('div');
    div.className = 'todo-item' + (todo.done ? ' is-done' : '');
    div.dataset.id = todo.id;
    div.innerHTML = `
      <button class="toggle-btn" title="Toggle done">${todo.done ? '✓' : ''}</button>
      <span class="todo-title">${todo.title}</span>
      <button class="delete-btn" title="Delete">×</button>
    `;
    bindItem(div);
    return div;
  }

  function bindItem(item) {
    // Toggle — optimistic: flip UI instantly, rollback if server fails
    item.querySelector('.toggle-btn').addEventListener('click', () => {
      const id = item.dataset.id;
      const wasDone = item.classList.contains('is-done');

      // 1. Update DOM immediately
      item.classList.toggle('is-done');
      item.querySelector('.toggle-btn').textContent =
        item.classList.contains('is-done') ? '✓' : '';
      updateSubtitle();

      // 2. Fire request in background — no await
      fetch(`/ui/todos/${id}/toggle`, { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Server error');
        })
        .catch(() => {
          // Rollback on failure
          if (wasDone) item.classList.add('is-done');
          else item.classList.remove('is-done');
          item.querySelector('.toggle-btn').textContent = wasDone ? '✓' : '';
          updateSubtitle();
        });
    });

    // Delete — optimistic: remove row instantly, rollback if server fails
    item.querySelector('.delete-btn').addEventListener('click', () => {
      if (!confirm('Delete this task?')) return;
      const id = item.dataset.id;
      const parent = item.parentNode;
      const nextSibling = item.nextSibling;

      // 1. Remove from DOM immediately
      item.remove();
      updateSubtitle();

      // 2. Fire request in background — no await
      fetch(`/ui/todos/${id}/delete`, { method: 'POST' })
        .then(res => {
          if (!res.ok) throw new Error('Server error');
        })
        .catch(() => {
          // Rollback — re-insert item at its original position
          parent.insertBefore(item, nextSibling);
          updateSubtitle();
        });
    });
  }

  // Bind existing items
  if (list) {
    list.querySelectorAll('.todo-item').forEach(bindItem);
    updateSubtitle();
  }

  // Async add
  const addForm = document.getElementById('add-form');
  const addInput = document.getElementById('add-input');
  if (addForm) {
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = addInput.value.trim();
      if (!title) return;
      const res = await fetch('/todos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
      });
      if (res.ok) {
        const todo = await res.json();
        if (!list) location.reload(); // fallback if no list element yet
        list.style.display = '';
        list.appendChild(makeItem(todo));
        addInput.value = '';
        updateSubtitle();
      }
    });
  }
</script>
{% endblock %}
